{% extends "base.html" %} {% block title %}Verify MFA{% endblock %} {% block
content %}

<!-- External scripts for draw widget -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<h1>Verify MFA</h1>
<p>
    To verify MFA, draw your initials in the provided box. It will be validated against your saved signatures in the database for a probabilistic match.
</p>

<span id="mfa-fail-text" hidden="True"><h4>MFA Failed! You may refresh the page to try again.</h4></span>

<bold>Enter your initials:</bold>

<style>
    body {
        display: flex;
        justify-content: center;
        padding-top: 50px;
    }
    canvas {
        border: 1px solid #ccc;
    }
</style>

<!-- Script logic for draw widget -->
<script>
    let socket = io();
    let canDraw = false;
    let inkOut = false;
    let lastSent = 0;
    const sendInterval = 50;

    socket.on("status_message", (data) => {
        document.getElementById("statusBar").innerText =
            "Status: " + data.message;
    });

    socket.on("ink_out", () => {
        console.log("Ink has run out!");
        inkOut = true;
    });

    socket.on("ink_status", (data) => {
        const bar = document.getElementById("inkBar");
        bar.style.width = `${data.percent}%`;

        if (data.percent < 30) {
            bar.style.background = "#f44336"; // red
        } else if (data.percent < 70) {
            bar.style.background = "#ff9800"; // orange
        } else {
            bar.style.background = "#4caf50"; // green
        }
    });

    socket.on("disconnect", function (data) {
        canDraw = false;
    });

    socket.on("mfa-passed", () => {
      document.getElementById('dashboard-button').disabled = False;
    });

    socket.io("mfa-failed", () => {
      document.getElementById('mfa-fail-text').hidden = False;
    })

    socket.on("reset_canvas", () => {
        reset(500, 1000);
    });

    function mousePressed() {
        if (!inkOut) {
            canDraw = true;
        }
    }

    function sendMousePosition() {
        const now = Date.now();
        if (now - lastSent >= sendInterval) {
            socket.emit("mouse_data", {
                x: mouseX,
                y: mouseY,
                t: now,
            });
            lastSent = now;
        }
    }

    function setup() {
        createCanvas(350, 350);
        background(255);
        strokeWeight(6);
        stroke(0);
    }

    function draw() {
        if (
            canDraw &&
            !inkOut &&
            mouseX >= 0 &&
            mouseX <= width &&
            mouseY >= 0 &&
            mouseY <= height
        ) {
            line(pmouseX, pmouseY, mouseX, mouseY);
            sendMousePosition();
        }
    }

    function reset(fadeDelay = 300, fadeDuration = 800) {
        inkOut = false;
        lastSent = 0;
        canDraw = false;

        const canvasElt = document.querySelector("canvas");
        canvasElt.style.transition = `opacity ${fadeDuration}ms`;
        canvasElt.style.opacity = 0;

        setTimeout(() => {
            clear(); // p5.js canvas clear
            background(255); // white background again
            strokeWeight(6); // reset stroke properties
            stroke(0); // black ink
            canvasElt.style.opacity = 1;
        }, fadeDelay);
    }
</script>

<div
    style="
        width: 350px;
        height: 20px;
        background: #eee;
        border: 1px solid #ccc;
        margin-bottom: 10px;
    "
>
    <div
        id="inkBar"
        style="height: 100%; width: 100%; background: #4caf50"
    ></div>
</div>

<div
    id="statusBar"
    style="margin-top: 10px; font-family: sans-serif; font-size: 16px"
>
    Status: Ready
</div>

<a href="{{ url_for('main.dashboard') }}">
    <button id="dashboard-button", disabled=True">Go to Dashboard</button>
</a>

{% endblock %}
