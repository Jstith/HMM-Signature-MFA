{% extends "base.html" %} {% block title %}MFA Setup{% endblock %} {% block
content %}

<!-- External scripts for draw widget -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow" style="max-width: 400px">
                <div class="card-body px-4 pb-4">
                    <h1 class="mb-3">Set up MFA</h1>
                    <p>
                        To set up MFA, draw your initials in the provided box
                        three times. Detailed and percise initials result in a
                        better MFA token (note: entries are timed for added
                        consistency).
                    </p>

                    <span id="mfa-fail-text" hidden="True"
                        ><h4>
                            MFA failed due to parameter mis-match! Please
                            refresh the page and try again (make sure to draw
                            the same shape each time).
                        </h4></span
                    >

                    <p class="fw-bold d-inline">Enter your initials:</p>
                    <div id="token-counter" class="d-inline mx-2">3</div>
                    <p class="fw-bold d-inline">more times</p>
                    <div
                        id="canvas-container"
                        class="my-3 d-flex justify-content-center"
                    >
                        <!-- Canvas will be inserted by p5.js -->
                        <style>
                            canvas {
                                border: 1px solid #ccc;
                                max-width: 100%;
                                height: auto;
                                display: block;
                            }
                        </style>
                    </div>
                    <div class="progress mb-4" style="height: 20px">
                        <div
                            id="inkBar"
                            class="progress-bar bg-success"
                            role="progressbar"
                            style="width: 100%"
                            aria-valuenow="100"
                            aria-valuemin="0"
                            aria-valuemax="100"
                        ></div>
                    </div>
                    <div
                        id="statusBar"
                        class="mb-3"
                        style="font-family: sans-serif; font-size: 16px"
                    >
                        Status: Ready
                    </div>
                    <button
                        id="verify-button"
                        class="btn btn-primary w-100 mb-4"
                        disabled
                    >
                        Go to MFA Verification
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script logic for draw widget -->
<script>
    let socket = io();
    let canDraw = false;
    let inkOut = false;
    let lastSent = 0;
    const sendInterval = 50;

    socket.on("status_message", (data) => {
        document.getElementById("statusBar").innerText =
            "Status: " + data.message;
    });

    socket.on("ink_out", () => {
        console.log("Ink has run out!");
        inkOut = true;
    });

    socket.on("ink_status", (data) => {
        console.log(data);

        const bar = document.getElementById("inkBar");
        bar.style.width = `${data.percent}%`;

        if (data.percent < 30) {
            bar.classList.remove("bg-success", "bg-warning");
            bar.classList.add("bg-danger");
        } else if (data.percent < 70) {
            bar.classList.remove("bg-success", "bg-danger");
            bar.classList.add("bg-warning");
        } else {
            bar.classList.remove("bg-warning", "bg-danger");
            bar.classList.add("bg-success");
        }
    });

    socket.on("disconnect", function () {
        canDraw = false;
        inkOut = true;
    });

    document.addEventListener("DOMContentLoaded", function () {
        const verifyButton = document.getElementById("verify-button");

        if (verifyButton) {
            verifyButton.addEventListener("click", function () {
                if (!verifyButton.disabled) {
                    window.location.href = "{{ url_for('mfa.verify_mfa') }}";
                }
            });
        }

        socket.on("update_content", (data) => {
            const counter = document.getElementById("token-counter");

            if (counter) {
                counter.textContent = data.new_html;
            }

            if (verifyButton) {
                verifyButton.disabled = data.button_disabled;
            }
        });
    });

    socket.on("reset_canvas", () => {
        reset(500, 1000);
    });

    function mousePressed() {
        if (!inkOut) {
            canDraw = true;
        }
    }

    function sendMousePosition() {
        const now = Date.now();
        if (now - lastSent >= sendInterval) {
            socket.emit("mouse_data", {
                x: mouseX,
                y: mouseY,
                t: now,
            });
            lastSent = now;
        }
    }

    function setup() {
        const canvas = createCanvas(350, 350);
        canvas.parent("canvas-container");
        background(255);
        strokeWeight(6);
        stroke(0);
    }

    function draw() {
        if (
            canDraw &&
            !inkOut &&
            mouseX >= 0 &&
            mouseX <= width &&
            mouseY >= 0 &&
            mouseY <= height
        ) {
            line(pmouseX, pmouseY, mouseX, mouseY);
            sendMousePosition();
        }
    }

    function reset(fadeDelay = 300, fadeDuration = 800) {
        inkOut = false;
        lastSent = 0;
        canDraw = false;

        const canvasElt = document.querySelector("canvas");
        canvasElt.style.transition = `opacity ${fadeDuration}ms`;
        canvasElt.style.opacity = 0;

        setTimeout(() => {
            clear(); // p5.js canvas clear
            background(255); // white background again
            strokeWeight(6); // reset stroke properties
            stroke(0); // black ink
            canvasElt.style.opacity = 1;
        }, fadeDelay);
    }
</script>

{% endblock %}
